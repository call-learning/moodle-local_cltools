{"version":3,"sources":["../../../src/local/table/tabulator-converters.js"],"names":["dateEditor","cell","onRendered","success","editor","document","createElement","setAttribute","style","padding","width","boxSizing","value","getValue","format","focus","css","successFunc","addEventListener","TABULATOR_FILTER_CONVERTER","to","transformer","tristate","indeterminateValue","args","values","choices","headerFilterFunc","outputformat","inputformat","timezone","TABULATOR_FORMATTER_CONVERTER","allowEmpty","allowTruthy","formatterFilterTransform","columndefs","map","columndef","formatterParams","JSON","parse","formatterparams","filterParams","filterparams","formatter","converter","headerFilter","filter","headerFilterParams"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * AMD module to convert between Moodle fields and format and Tabulator formats.\n *\n * @module   local_cltools/table/dynamic.js\n * @copyright 2021 - CALL Learning - Laurent David <laurent@call-learning.fr>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport moment from 'local_cltools/local/moment-lazy';\n\nconst dateEditor = (cell, onRendered, success) => {\n    // Create and style editor.\n    var editor = document.createElement(\"input\");\n\n    editor.setAttribute(\"type\", \"date\");\n\n    // Create and style input\n    editor.style.padding = \"3px\";\n    editor.style.width = \"100%\";\n    editor.style.boxSizing = \"border-box\";\n\n    // Set value of editor to the current value of the cell.\n    editor.value = moment(cell.getValue(), \"DD/MM/YYYY\").format(\"YYYY-MM-DD\");\n\n    // Set focus on the select box when the editor is selected (timeout allows for editor to be added to DOM)\n    onRendered(function () {\n        editor.focus();\n        editor.style.css = \"100%\";\n    });\n\n    // When the value has been set, trigger the cell to update\n    function successFunc() {\n        success(moment(editor.value, \"YYYY-MM-DD\").format(\"DD/MM/YYYY\"));\n    }\n\n    editor.addEventListener(\"change\", successFunc);\n    editor.addEventListener(\"blur\", successFunc);\n\n    // Return the editor element\n    return editor;\n};\n\nconst TABULATOR_FILTER_CONVERTER = {\n    'text': {\n        to: 'input'\n    },\n    'boolean': {\n        to: 'tick',\n        transformer: () => {\n            return {\n                tristate: true,\n                indeterminateValue: \"n/a\"\n            };\n        },\n    },\n    'select_choice': {\n        to: 'select',\n        transformer: (args) => {\n            return {values: args.choices};\n        },\n        headerFilterFunc: \"=\"\n    },\n    'entity_selector': {\n        to: 'select',\n        transformer: (args) => {\n            return {values: args.choices};\n        },\n        headerFilterFunc: \"=\"\n    },\n    'datetime': {\n        to: 'datetime',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.outputformat,\n                'inputFormat': args.inputformat,\n                'timezone': args.timezone\n            };\n        },\n        editor: dateEditor\n    }\n};\nconst TABULATOR_FORMATTER_CONVERTER = {\n    'text': {\n        to: 'plaintext',\n    },\n    'boolean': {\n        to: 'tickCross',\n        transformer: () => {\n            return {\n                allowEmpty: true,\n                allowTruthy: true,\n            };\n        }\n    },\n    'number': {\n        to: 'plaintext',\n    },\n    'select_choice': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'entity_selector': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'datetime': {\n        to: 'datetimets',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.outputformat,\n                'timezone': args.timezone\n            };\n        }\n    },\n    'date': {\n        to: 'datets',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.outputformat,\n                'timezone': args.timezone\n            };\n        }\n    }\n};\n\nexport const formatterFilterTransform = (columndefs) => {\n    return columndefs.map(\n        (columndef) => {\n            const formatterParams = ('formatterparams' in columndef) ? JSON.parse(columndef.formatterparams) : null;\n            const filterParams = ('filterparams' in columndef) ? JSON.parse(columndef.filterparams) : null;\n            if (('formatter' in columndef) && (columndef.formatter in TABULATOR_FORMATTER_CONVERTER)) {\n                const converter = TABULATOR_FORMATTER_CONVERTER[columndef.formatter];\n                if (formatterParams) {\n                    columndef.formatterParams = converter.transformer(formatterParams);\n                }\n                columndef.formatter = converter.to;\n            }\n            if (('filter' in columndef)) {\n                columndef.headerFilter = columndef.filter;\n                if (columndef.filter in TABULATOR_FILTER_CONVERTER) {\n                    const converter = TABULATOR_FILTER_CONVERTER[columndef.filter];\n                    if (converter.transformer) {\n                        columndef.headerFilterParams = converter.transformer(filterParams);\n                    }\n                    columndef.headerFilter = converter.to;\n                    if ('editor' in converter) {\n                        columndef.editor = converter.editor;\n                    }\n                    if ('headerFilterFunc' in converter) {\n                        columndef.headerFilterFunc = converter.headerFilterFunc;\n                    }\n                }\n                delete columndef.filter;\n            }\n            if ('formatterparams' in columndef) {\n                delete columndef.formatterparams;\n            }\n            if ('filterparams' in columndef) {\n                delete columndef.filterparams;\n            }\n            return columndef;\n        }\n    );\n};"],"file":"tabulator-converters.min.js"}