{"version":3,"sources":["../../../src/local/table/dynamic.js"],"names":["TABULATOR_FORMATTER_CONVERTER","to","transformer","args","choices","inputformat","timezone","dateEditor","cell","onRendered","success","editor","document","createElement","setAttribute","style","padding","width","boxSizing","value","getValue","format","focus","css","successFunc","addEventListener","TABULATOR_FILTER_CONVERTER","values","headerFilterFunc","formatterFilterTransform","columndefs","map","columndef","formatterParams","JSON","parse","formatterparams","filterParams","filterparams","formatter","converter","filter","headerFilterParams","headerFilter","toNumericEqual","val","stringify","direction","MOODLE_FILTER_CONVERTER","Array","isArray","rowQuery","tableHandler","tableUniqueid","pageSize","params","initialFilters","filters","e","field","type","concat","handler","uniqueid","sortdata","sorters","dir","toUpperCase","jointype","pagenumber","page","pagesize","hiddencolumns","resetpreferences","firstinitial","lastinitial","Promise","race","methodname","catch","Notification","exception","ajaxResponseProcessor","url","response","data","rowstring","init","tabulatorelementid","requiredFilters","window","moment","tableelement","placeHolderMessage","columns","Tabulator","ajaxRequestFunc","config","table","getPageSize","ajaxURL","pagination","paginationSize","ajaxFiltering","ajaxSorting","paginationDataReceived","ajaxResponse","layout","placeholder","rowClick","row","trigger"],"mappings":"6RAAA,OACA,OACA,OAEA,O,qXAGMA,CAAAA,CAA6B,CAAG,CAClC,cAAiB,CACbC,EAAE,CAAE,QADS,CAEbC,WAAW,CAAE,qBAACC,CAAD,QAAUA,CAAAA,CAAI,CAACC,OAAf,CAFA,CADiB,CAKlC,gBAAmB,CACfH,EAAE,CAAE,QADW,CAEfC,WAAW,CAAE,qBAACC,CAAD,QAAUA,CAAAA,CAAI,CAACC,OAAf,CAFE,CALe,CASlC,SAAY,CACRH,EAAE,CAAE,UADI,CAERC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,MAAO,CACH,aAAgBA,CAAI,CAACE,WADlB,CAEH,YAAeF,CAAI,CAACE,WAFjB,CAGH,SAAYF,CAAI,CAACG,QAHd,CAKV,CARO,CATsB,C,CAqBhCC,CAAU,CAAG,SAACC,CAAD,CAAOC,CAAP,CAAmBC,CAAnB,CAA+B,CAE9C,GAAIC,CAAAA,CAAM,CAAGC,QAAQ,CAACC,aAAT,CAAuB,OAAvB,CAAb,CAEAF,CAAM,CAACG,YAAP,CAAoB,MAApB,CAA4B,MAA5B,EAGAH,CAAM,CAACI,KAAP,CAAaC,OAAb,CAAuB,KAAvB,CACAL,CAAM,CAACI,KAAP,CAAaE,KAAb,CAAqB,MAArB,CACAN,CAAM,CAACI,KAAP,CAAaG,SAAb,CAAyB,YAAzB,CAGAP,CAAM,CAACQ,KAAP,CAAe,cAAOX,CAAI,CAACY,QAAL,EAAP,CAAwB,YAAxB,EAAsCC,MAAtC,CAA6C,YAA7C,CAAf,CAGAZ,CAAU,CAAC,UAAW,CAClBE,CAAM,CAACW,KAAP,GACAX,CAAM,CAACI,KAAP,CAAaQ,GAAb,CAAmB,MACtB,CAHS,CAAV,CAMA,QAASC,CAAAA,CAAT,EAAuB,CACnBd,CAAO,CAAC,cAAOC,CAAM,CAACQ,KAAd,CAAqB,YAArB,EAAmCE,MAAnC,CAA0C,YAA1C,CAAD,CACV,CAEDV,CAAM,CAACc,gBAAP,CAAwB,QAAxB,CAAkCD,CAAlC,EACAb,CAAM,CAACc,gBAAP,CAAwB,MAAxB,CAAgCD,CAAhC,EAGA,MAAOb,CAAAA,CACV,C,CAEKe,CAA0B,CAAG,CAC/B,KAAQ,CACJzB,EAAE,CAAE,OADA,CADuB,CAI/B,cAAiB,CACbA,EAAE,CAAE,QADS,CAEbC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,MAAO,CAACwB,MAAM,CAAExB,CAAI,CAACC,OAAd,CACV,CAJY,CAKbwB,gBAAgB,CAAE,GALL,CAJc,CAW/B,gBAAmB,CACf3B,EAAE,CAAE,QADW,CAEfC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,MAAO,CAACwB,MAAM,CAAExB,CAAI,CAACC,OAAd,CACV,CAJc,CAKfwB,gBAAgB,CAAE,GALH,CAXY,CAkB/B,SAAY,CACR3B,EAAE,CAAE,UADI,CAERC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,MAAO,CACH,aAAgBA,CAAI,CAACE,WADlB,CAEH,YAAeF,CAAI,CAACE,WAFjB,CAGH,SAAYF,CAAI,CAACG,QAHd,CAKV,CARO,CASRK,MAAM,CAAEJ,CATA,CAlBmB,C,CA8B7BsB,CAAwB,CAAG,SAACC,CAAD,CAAgB,CAC7C,MAAOA,CAAAA,CAAU,CAACC,GAAX,CACH,SAACC,CAAD,CAAe,IACLC,CAAAA,CAAe,CAAI,mBAAqBD,CAAAA,CAAtB,CAAmCE,IAAI,CAACC,KAAL,CAAWH,CAAS,CAACI,eAArB,CAAnC,CAA2E,IADxF,CAELC,CAAY,CAAI,gBAAkBL,CAAAA,CAAnB,CAAgCE,IAAI,CAACC,KAAL,CAAWH,CAAS,CAACM,YAArB,CAAhC,CAAqE,IAF/E,CAGX,GAAI,CAACL,CAAL,CAAsB,CAClB,MAAOD,CAAAA,CAAS,CAACI,eACpB,CACD,GAAI,CAACC,CAAL,CAAmB,CACf,MAAOL,CAAAA,CAAS,CAACM,YACpB,CACD,GAAK,aAAeN,CAAAA,CAAhB,EAA+BA,CAAS,CAACO,SAAV,GAAuBvC,CAAAA,CAA1D,CAA0F,CACtF,GAAMwC,CAAAA,CAAS,CAAGxC,CAA6B,CAACgC,CAAS,CAACO,SAAX,CAA/C,CACA,GAAIN,CAAJ,CAAqB,CACjBD,CAAS,CAACC,eAAV,CAA4BO,CAAS,CAACtC,WAAV,CAAsB+B,CAAtB,CAC/B,CACDD,CAAS,CAACO,SAAV,CAAsBC,CAAS,CAACvC,EACnC,CACD,GAAK,UAAY+B,CAAAA,CAAb,EAA4BA,CAAS,CAACS,MAAV,GAAoBf,CAAAA,CAApD,CAAiF,CAC7E,GAAMc,CAAAA,CAAS,CAAGd,CAA0B,CAACM,CAAS,CAACS,MAAX,CAA5C,CACA,GAAIJ,CAAJ,CAAkB,CACdL,CAAS,CAACU,kBAAV,CAA+BF,CAAS,CAACtC,WAAV,CAAsBmC,CAAtB,CAClC,CACDL,CAAS,CAACW,YAAV,CAAyBH,CAAS,CAACvC,EAAnC,CACA,GAAI,UAAYuC,CAAAA,CAAhB,CAA2B,CACvBR,CAAS,CAACrB,MAAV,CAAmB6B,CAAS,CAAC7B,MAChC,CACD,GAAI,oBAAsB6B,CAAAA,CAA1B,CAAqC,CACjCR,CAAS,CAACJ,gBAAV,CAA6BY,CAAS,CAACZ,gBAC1C,CACJ,CACD,MAAOI,CAAAA,CACV,CA/BE,CAiCV,C,CAEKY,CAAc,CAAG,SAACC,CAAD,QAASX,CAAAA,IAAI,CAACY,SAAL,CAAe,CAC3CC,SAAS,CAAE,GADgC,CAE3C5B,KAAK,CAAE0B,CAFoC,CAAf,CAAT,C,CAKjBG,CAAuB,CAAG,CAC5B,KAAQ,CACJ/C,EAAE,CAAE,eADA,CAEJC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,MAAO,CAACgB,KAAK,CAAEhB,CAAR,CACV,CAJG,CADoB,CAO5B,IAAK,CACDF,EAAE,CAAE,2BADH,CAEDC,WAAW,CAAE,qBAACC,CAAD,CAAU,CACnB,GAAI8C,KAAK,CAACC,OAAN,CAAc/C,CAAd,CAAJ,CAAyB,CACrB,MAAOA,CAAAA,CAAI,CAAC4B,GAAL,CAASa,CAAT,CACV,CAFD,IAEO,CACH,MAAO,CAACA,CAAc,CAACzC,CAAD,CAAf,CACV,CACJ,CARA,CAPuB,C,CAsB1BgD,CAAQ,CAAG,SAACC,CAAD,CAAeC,CAAf,CAA8BC,CAA9B,CAAwCC,CAAxC,CAAgDC,CAAhD,CAAmE,CAChF,GAAIC,CAAAA,CAAO,CAA8B,WAA1B,QAAOF,CAAAA,CAAM,CAACE,OAAf,CAA0C,EAA1C,CAA+CF,CAAM,CAACE,OAAP,CAAe1B,GAAf,CACzD,SAAC2B,CAAD,CAAO,CACH,GAAIjB,CAAAA,CAAM,CAAG,CACT,KAAQiB,CAAC,CAACC,KADD,CACQ,KAAQD,CAAC,CAACE,IADlB,CACwB,SAP5B,CAMI,CACkD,OAAUF,CAAC,CAACvC,KAD9D,CAAb,CAGA,GAAIuC,CAAC,CAACE,IAAF,GAAUZ,CAAAA,CAAd,CAAuC,CACnC,GAAMR,CAAAA,CAAS,CAAGQ,CAAuB,CAACU,CAAC,CAACE,IAAH,CAAzC,CACAnB,CAAM,CAACmB,IAAP,CAAcpB,CAAS,CAACvC,EAAxB,CACA,GAAqC,WAAjC,QAAOuC,CAAAA,CAAS,CAACtC,WAArB,CAAkD,CAC9CuC,CAAM,CAACd,MAAP,CAAgBa,CAAS,CAACtC,WAAV,CAAsBwD,CAAC,CAACvC,KAAxB,CACnB,CACJ,CACD,MAAOsB,CAAAA,CACV,CAbwD,CAA7D,CAeA,GAAIe,CAAJ,CAAoB,CAChBC,CAAO,CAACI,MAAR,CAAeL,CAAf,CACH,CACD,GAAMrD,CAAAA,CAAI,CAAG,CACT2D,OAAO,CAAEV,CADA,CAETW,QAAQ,CAAEV,CAFD,CAGTW,QAAQ,CAA6B,WAA1B,QAAOT,CAAAA,CAAM,CAACU,OAAf,CAA0C,EAA1C,CAA+CV,CAAM,CAACU,OAAP,CAAelC,GAAf,CACrD,SAAC2B,CAAD,CAAO,CACH,MAAO,CAAC,OAAUA,CAAC,CAACC,KAAb,CAAoB,UAAaD,CAAC,CAACQ,GAAF,CAAMC,WAAN,EAAjC,CACV,CAHoD,CAHhD,CAQTV,OAAO,CAAEA,CARA,CASTW,QAAQ,CA9BK,CAqBJ,CAUTC,UAAU,CAAEd,CAAM,CAACe,IAVV,CAWTC,QAAQ,CAAEjB,CAXD,CAYTkB,aAAa,CAAE,EAZN,CAaTC,gBAAgB,GAbP,CAcTC,YAAY,CAAE,GAdL,CAeTC,WAAW,CAAE,GAfJ,CAAb,CAiBA,MAAOC,CAAAA,OAAO,CAACC,IAAR,CACH,WACI,CAAC,CACGC,UAAU,CAAE,gCADf,CAEG3E,IAAI,CAAEA,CAFT,CAAD,CADJ,CADG,EAOL4E,KAPK,CAOCC,UAAaC,SAPd,CAQV,C,CAEKC,CAAqB,CAAG,SAASC,CAAT,CAAc5B,CAAd,CAAsB6B,CAAtB,CAAgC,CAC1DA,CAAQ,CAACC,IAAT,CAAgBD,CAAQ,CAACC,IAAT,CAActD,GAAd,CACZ,SAACuD,CAAD,QAAepD,CAAAA,IAAI,CAACC,KAAL,CAAWmD,CAAX,CAAf,CADY,CAAhB,CAGA,MAAOF,CAAAA,CACV,C,CAEYG,CAAI,4CAAG,WAAMC,CAAN,CAA0BC,CAA1B,6FAChB,GAA4B,WAAxB,QAAOC,CAAAA,MAAM,CAACC,MAAlB,CAAyC,CACrCD,MAAM,CAACC,MAAP,CAAgBA,SACnB,CACKC,CAJU,CAIK,cAAE,IAAMJ,CAAR,CAJL,gBAMiB,iBAAU,cAAV,CAA0B,eAA1B,CANjB,QAMVK,CANU,uBAOMjB,CAAAA,OAAO,CAACC,IAAR,CAAa,WAC/B,CAAC,CACGC,UAAU,CAAE,mCADf,CAEG3E,IAAI,CAAE,CACF2D,OAAO,CAAE8B,CAAY,CAACP,IAAb,CAAkB,cAAlB,CADP,CAEFtB,QAAQ,CAAE6B,CAAY,CAACP,IAAb,CAAkB,eAAlB,CAFR,CAFT,CAAD,CAD+B,CAAb,EAObN,KAPa,CAOPC,UAAaC,SAPN,CAPN,QAOVa,CAPU,QAehB,GAAIC,UAAJ,CAAc,IAAMP,CAApB,CAAwC,CACpCQ,eAAe,CAAE,yBAASb,CAAT,CAAcc,CAAd,CAAsB1C,CAAtB,CAA8B,IACrCH,CAAAA,CAAY,CAAGwC,CAAY,CAACP,IAAb,CAAkB,cAAlB,CADsB,CAErChC,CAAa,CAAGuC,CAAY,CAACP,IAAb,CAAkB,eAAlB,CAFqB,CAGrC/B,CAAQ,CAAG,KAAK4C,KAAL,CAAWC,WAAX,EAH0B,CAI3C,MAAOhD,CAAAA,CAAQ,CAACC,CAAD,CAAeC,CAAf,CAA8BC,CAA9B,CAAwCC,CAAxC,CAAgDkC,CAAhD,CAClB,CANmC,CAOpCW,OAAO,GAP6B,CAQpCC,UAAU,CAAE,QARwB,CASpCC,cAAc,CAAEV,CAAY,CAACP,IAAb,CAAkB,gBAAlB,CAToB,CAUpCkB,aAAa,GAVuB,CAWpCC,WAAW,GAXyB,CAYpCC,sBAAsB,CAAE,CACpB,UAAa,YADO,CAZY,CAepCC,YAAY,CAAExB,CAfsB,CAgBpCY,OAAO,CAAEjE,CAAwB,CAACiE,CAAD,CAhBG,CAiBpCa,MAAM,CAAE,YAjB4B,CAkBpCC,WAAW,CAAEf,CAlBuB,CAmBpCgB,QAAQ,CAAE,kBAACnD,CAAD,CAAIoD,CAAJ,CAAY,CAClB,cAAElG,QAAF,EAAYmG,OAAZ,CAAoB,qBAApB,CAA2C,CAACD,CAAD,CAAMlB,CAAY,CAACP,IAAb,CAAkB,eAAlB,CAAN,CAA3C,CACH,CArBmC,CAAxC,EAfgB,wCAAH,uD","sourcesContent":["import Tabulator from 'local_cltools/local/table/tabulator-lazy';\nimport moment from 'local_cltools/local/moment-lazy';\nimport $ from 'jquery';\nimport {call as ajaxCall} from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\nconst TABULATOR_FORMATTER_CONVERTER = {\n    'select_choice': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'entity_selector': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'datetime': {\n        to: 'datetime',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.inputformat,\n                'inputFormat': args.inputformat,\n                'timezone': args.timezone\n            };\n        }\n    }\n};\n\nconst dateEditor = (cell, onRendered, success) => {\n    // Create and style editor.\n    var editor = document.createElement(\"input\");\n\n    editor.setAttribute(\"type\", \"date\");\n\n    // Create and style input\n    editor.style.padding = \"3px\";\n    editor.style.width = \"100%\";\n    editor.style.boxSizing = \"border-box\";\n\n    // Set value of editor to the current value of the cell.\n    editor.value = moment(cell.getValue(), \"DD/MM/YYYY\").format(\"YYYY-MM-DD\");\n\n    // Set focus on the select box when the editor is selected (timeout allows for editor to be added to DOM)\n    onRendered(function() {\n        editor.focus();\n        editor.style.css = \"100%\";\n    });\n\n    // When the value has been set, trigger the cell to update\n    function successFunc() {\n        success(moment(editor.value, \"YYYY-MM-DD\").format(\"DD/MM/YYYY\"));\n    }\n\n    editor.addEventListener(\"change\", successFunc);\n    editor.addEventListener(\"blur\", successFunc);\n\n    // Return the editor element\n    return editor;\n};\n\nconst TABULATOR_FILTER_CONVERTER = {\n    'text': {\n        to: 'input'\n    },\n    'select_choice': {\n        to: 'select',\n        transformer: (args) => {\n            return {values: args.choices};\n        },\n        headerFilterFunc: \"=\"\n    },\n    'entity_selector': {\n        to: 'select',\n        transformer: (args) => {\n            return {values: args.choices};\n        },\n        headerFilterFunc: \"=\"\n    },\n    'datetime': {\n        to: 'datetime',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.inputformat,\n                'inputFormat': args.inputformat,\n                'timezone': args.timezone\n            };\n        },\n        editor: dateEditor\n    }\n};\nconst formatterFilterTransform = (columndefs) => {\n    return columndefs.map(\n        (columndef) => {\n            const formatterParams = ('formatterparams' in columndef) ? JSON.parse(columndef.formatterparams) : null;\n            const filterParams = ('filterparams' in columndef) ? JSON.parse(columndef.filterparams) : null;\n            if (!formatterParams) {\n                delete columndef.formatterparams;\n            }\n            if (!filterParams) {\n                delete columndef.filterparams;\n            }\n            if (('formatter' in columndef) && (columndef.formatter in TABULATOR_FORMATTER_CONVERTER)) {\n                const converter = TABULATOR_FORMATTER_CONVERTER[columndef.formatter];\n                if (formatterParams) {\n                    columndef.formatterParams = converter.transformer(formatterParams);\n                }\n                columndef.formatter = converter.to;\n            }\n            if (('filter' in columndef) && (columndef.filter in TABULATOR_FILTER_CONVERTER)) {\n                const converter = TABULATOR_FILTER_CONVERTER[columndef.filter];\n                if (filterParams) {\n                    columndef.headerFilterParams = converter.transformer(filterParams);\n                }\n                columndef.headerFilter = converter.to;\n                if ('editor' in converter) {\n                    columndef.editor = converter.editor;\n                }\n                if ('headerFilterFunc' in converter) {\n                    columndef.headerFilterFunc = converter.headerFilterFunc;\n                }\n            }\n            return columndef;\n        }\n    );\n};\n\nconst toNumericEqual = (val) => JSON.stringify({\n    direction: '=',\n    value: val,\n});\n\nconst MOODLE_FILTER_CONVERTER = {\n    'like': {\n        to: 'string_filter',\n        transformer: (args) => {\n            return {value: args};\n        }\n    },\n    '=': {\n        to: 'numeric_comparison_filter',\n        transformer: (args) => {\n            if (Array.isArray(args)) {\n                return args.map(toNumericEqual);\n            } else {\n                return [toNumericEqual(args)];\n            }\n        }\n    }\n};\n\nconst JOINTYPE_ANY = 1;\nconst JOINTYPE_ALL = 2;\n\nconst rowQuery = (tableHandler, tableUniqueid, pageSize, params, initialFilters) => {\n    let filters = (typeof params.filters === \"undefined\") ? [] : params.filters.map(\n        (e) => {\n            let filter = {\n                'name': e.field, 'type': e.type, 'jointype': JOINTYPE_ANY, 'values': e.value\n            };\n            if (e.type in MOODLE_FILTER_CONVERTER) {\n                const converter = MOODLE_FILTER_CONVERTER[e.type];\n                filter.type = converter.to;\n                if (typeof converter.transformer !== \"undefined\") {\n                    filter.values = converter.transformer(e.value);\n                }\n            }\n            return filter;\n        }\n    );\n    if (initialFilters) {\n        filters.concat(initialFilters);\n    }\n    const args = {\n        handler: tableHandler,\n        uniqueid: tableUniqueid,\n        sortdata: (typeof params.sorters === \"undefined\") ? [] : params.sorters.map(\n            (e) => {\n                return {'sortby': e.field, 'sortorder': e.dir.toUpperCase()};\n            }\n        ),\n        filters: filters,\n        jointype: JOINTYPE_ALL,\n        pagenumber: params.page,\n        pagesize: pageSize,\n        hiddencolumns: [],\n        resetpreferences: false,\n        firstinitial: \"A\",\n        lastinitial: \"Z\"\n    };\n    return Promise.race(\n        ajaxCall(\n            [{\n                methodname: 'cltools_dynamic_table_get_rows',\n                args: args\n            }]\n        )\n    ).catch(Notification.exception);\n};\n\nconst ajaxResponseProcessor = function(url, params, response) {\n    response.data = response.data.map(\n        (rowstring) => JSON.parse(rowstring)\n    );\n    return response;\n};\n\nexport const init = async(tabulatorelementid, requiredFilters) => {\n    if (typeof window.moment == \"undefined\") {\n        window.moment = moment;\n    }\n    const tableelement = $(\"#\" + tabulatorelementid);\n\n    const placeHolderMessage = await getString('table:nodata', 'local_cltools');\n    const columns = await Promise.race(ajaxCall(\n        [{\n            methodname: 'cltools_dynamic_table_get_columns',\n            args: {\n                handler: tableelement.data('tableHandler'),\n                uniqueid: tableelement.data('tableUniqueid'),\n            }\n        }])).catch(Notification.exception);\n    new Tabulator(\"#\" + tabulatorelementid, {\n        ajaxRequestFunc: function(url, config, params) {\n            const tableHandler = tableelement.data('tableHandler');\n            const tableUniqueid = tableelement.data('tableUniqueid');\n            const pageSize = this.table.getPageSize();\n            return rowQuery(tableHandler, tableUniqueid, pageSize, params, requiredFilters);\n        },\n        ajaxURL: true, // If not set the RequestFunct will never be called.\n        pagination: \"remote\",\n        paginationSize: tableelement.data('table-pagesize'),\n        ajaxFiltering: true,\n        ajaxSorting: true,\n        paginationDataReceived: {\n            \"last_page\": \"pagescount\", // Change last_page parameter name to \"pagescount\".\n        },\n        ajaxResponse: ajaxResponseProcessor,\n        columns: formatterFilterTransform(columns),\n        layout: \"fitColumns\",\n        placeholder: placeHolderMessage,\n        rowClick: (e, row) => {\n            $(document).trigger('tabulator-row-click', [row, tableelement.data('tableUniqueid')]);\n        }\n    });\n\n};\n"],"file":"dynamic.min.js"}