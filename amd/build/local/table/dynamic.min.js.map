{"version":3,"sources":["../../../src/local/table/dynamic.js"],"names":["TABULATOR_FORMATTER_CONVERTER","to","transformer","args","choices","inputformat","timezone","dateEditor","cell","onRendered","success","editor","document","createElement","setAttribute","style","padding","width","boxSizing","value","getValue","format","focus","css","successFunc","addEventListener","TABULATOR_FILTER_CONVERTER","values","formatterFilterTransform","columndefs","map","columndef","formatterParams","JSON","parse","formatterparams","filterParams","filterparams","formatter","converter","filter","headerFilterParams","headerFilter","MOODLE_FILTER_CONVERTER","stringify","direction","rowQuery","tableHandler","tableUniqueid","pageSize","params","handler","uniqueid","sortdata","sorters","e","field","dir","toUpperCase","filters","type","jointype","pagenumber","page","pagesize","hiddencolumns","resetpreferences","firstinitial","lastinitial","Promise","race","methodname","catch","Notification","exception","ajaxResponseProcessor","url","response","data","rowstring","init","tabulatorelementid","window","moment","tableelement","placeHolderMessage","columns","Tabulator","ajaxRequestFunc","config","table","getPageSize","ajaxURL","pagination","paginationSize","ajaxFiltering","ajaxSorting","paginationDataReceived","ajaxResponse","layout","placeholder"],"mappings":"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","sourcesContent":["import Tabulator from 'local_cltools/local/table/tabulator-lazy';\nimport moment from 'local_cltools/local/moment-lazy';\nimport $ from 'jquery';\nimport {call as ajaxCall} from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\nconst TABULATOR_FORMATTER_CONVERTER = {\n    'select_choice': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'entity_selector': {\n        to: 'lookup',\n        transformer: (args) => args.choices\n    },\n    'datetime': {\n        to: 'datetime',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.inputformat,\n                'inputFormat': args.inputformat,\n                'timezone': args.timezone\n            };\n        }\n    }\n};\n\nconst dateEditor = (cell, onRendered, success) => {\n    // Create and style editor.\n    var editor = document.createElement(\"input\");\n\n    editor.setAttribute(\"type\", \"date\");\n\n    // Create and style input\n    editor.style.padding = \"3px\";\n    editor.style.width = \"100%\";\n    editor.style.boxSizing = \"border-box\";\n\n    // Set value of editor to the current value of the cell.\n    editor.value = moment(cell.getValue(), \"DD/MM/YYYY\").format(\"YYYY-MM-DD\");\n\n    // Set focus on the select box when the editor is selected (timeout allows for editor to be added to DOM)\n    onRendered(function(){\n        editor.focus();\n        editor.style.css = \"100%\";\n    });\n\n    // When the value has been set, trigger the cell to update\n    function successFunc(){\n        success(moment(editor.value, \"YYYY-MM-DD\").format(\"DD/MM/YYYY\"));\n    }\n\n    editor.addEventListener(\"change\", successFunc);\n    editor.addEventListener(\"blur\", successFunc);\n\n    // Return the editor element\n    return editor;\n};\n\nconst TABULATOR_FILTER_CONVERTER = {\n    'text' : {\n        to: 'input'\n    },\n    'select_choice': {\n        to: 'select',\n        transformer: (args) => {\n            return { values: args.choices };\n        }\n    },\n    'entity_selector': {\n        to: 'select',\n        transformer: (args) => {\n            return { values: args.choices };\n        }\n    },\n    'datetime': {\n        to: 'datetime',\n        transformer: (args) => {\n            return {\n                'outputFormat': args.inputformat,\n                'inputFormat': args.inputformat,\n                'timezone': args.timezone\n            };\n        },\n        editor: dateEditor\n    }\n};\nconst formatterFilterTransform = (columndefs) => {\n    return columndefs.map(\n        (columndef) => {\n            const formatterParams = ('formatterparams' in columndef) ? JSON.parse(columndef.formatterparams) : null;\n            const filterParams = ('filterparams' in columndef) ? JSON.parse(columndef.filterparams) : null;\n            if (!formatterParams) {\n                delete columndef.formatterparams;\n            }\n            if (!filterParams) {\n                delete columndef.filterparams;\n            }\n            if (('formatter' in columndef) && (columndef.formatter in TABULATOR_FORMATTER_CONVERTER)) {\n                const converter = TABULATOR_FORMATTER_CONVERTER[columndef.formatter];\n                if (formatterParams) {\n                    columndef.formatterParams = converter.transformer(formatterParams);\n                }\n                columndef.formatter = converter.to;\n            }\n            if (('filter' in columndef) && (columndef.filter in TABULATOR_FILTER_CONVERTER)) {\n                const converter = TABULATOR_FILTER_CONVERTER[columndef.filter];\n                if (filterParams) {\n                    columndef.headerFilterParams = converter.transformer(filterParams);\n                }\n                columndef.headerFilter = converter.to;\n                if ('editor' in converter) {\n                    columndef.editor = converter.editor;\n                }\n            }\n            return columndef;\n        }\n    );\n};\n\nconst MOODLE_FILTER_CONVERTER = {\n    'input' : {\n        to: 'string_filter'\n    },\n    'like': {\n        to: 'numeric_comparison_filter',\n        transformer:(args) => {\n            return [\n                JSON.stringify({\n                direction : '=',\n                value : args,\n            })];\n        }\n    }\n};\nconst rowQuery = (tableHandler, tableUniqueid, pageSize, params)  => {\n    const args = {\n        handler: tableHandler,\n        uniqueid: tableUniqueid,\n        sortdata: (typeof params.sorters === \"undefined\") ? [] : params.sorters.map(\n            (e) => {\n                return {'sortby': e.field, 'sortorder': e.dir.toUpperCase()};\n            }\n        ),\n        filters: (typeof params.filters === \"undefined\") ? [] : params.filters.map(\n            (e) => {\n                let filter = {\n                    'name': e.field, 'type': e.type ,'jointype': 1, 'values': e.value\n                };\n                if (e.type in MOODLE_FILTER_CONVERTER) {\n                    const converter = MOODLE_FILTER_CONVERTER[e.type];\n                    filter.type = converter.to;\n                    if (typeof converter.transformer !== \"undefined\") {\n                        filter.values = converter.transformer(e.value);\n                    }\n                }\n                return filter;\n            }\n        ),\n        jointype: 1,\n        pagenumber: params.page,\n        pagesize: pageSize,\n        hiddencolumns: [],\n        resetpreferences: false,\n        firstinitial: \"A\",\n        lastinitial: \"Z\"\n    };\n    return Promise.race(\n        ajaxCall(\n            [{\n                methodname: 'cltools_dynamic_table_get_rows',\n                args: args\n            }]\n        )\n    ).catch(Notification.exception);\n};\n\nconst ajaxResponseProcessor = function (url, params, response) {\n    response.data = response.data.map(\n        (rowstring) => JSON.parse(rowstring)\n    );\n    return response;\n};\n\nexport const init = async (tabulatorelementid) => {\n    if (typeof window.moment == \"undefined\") {\n        window.moment = moment;\n    }\n    const tableelement = $(\"#\" + tabulatorelementid);\n\n    const placeHolderMessage = await getString('table:nodata', 'local_cltools');\n    const columns = await Promise.race(ajaxCall(\n        [{\n            methodname: 'cltools_dynamic_table_get_columns',\n            args: {\n                handler: tableelement.data('tableHandler'),\n                uniqueid: tableelement.data('tableUniqueid'),\n            }\n        }])).catch(Notification.exception);\n    new Tabulator(\"#\" + tabulatorelementid, {\n        ajaxRequestFunc: function (url, config, params) {\n            const tableHandler = tableelement.data('tableHandler');\n            const tableUniqueid = tableelement.data('tableUniqueid');\n            const pageSize = this.table.getPageSize();\n            return rowQuery(tableHandler, tableUniqueid, pageSize, params);\n        },\n        ajaxURL: true, // If not set the RequestFunct will never be called.\n        pagination: \"remote\",\n        paginationSize: tableelement.data('table-pagesize'),\n        ajaxFiltering: true,\n        ajaxSorting: true,\n        paginationDataReceived: {\n            \"last_page\": \"pagescount\", // Change last_page parameter name to \"pagescount\".\n        },\n        ajaxResponse: ajaxResponseProcessor,\n        columns: formatterFilterTransform(columns),\n        layout: \"fitColumns\",\n        placeholder: placeHolderMessage\n    });\n\n};\n"],"file":"dynamic.min.js"}