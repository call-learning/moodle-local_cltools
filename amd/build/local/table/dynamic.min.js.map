{"version":3,"sources":["../../../src/local/table/dynamic.js"],"names":["rowQuery","tableHandler","tableUniqueid","pageSize","params","initialFilters","filters","map","e","filter","field","type","JOINTYPE_ANY","value","MOODLE_FILTER_CONVERTER","converter","to","transformer","values","concat","args","handler","uniqueid","sortdata","sorters","dir","toUpperCase","jointype","JOINTYPE_ALL","pagenumber","page","pagesize","hiddencolumns","resetpreferences","firstinitial","lastinitial","Promise","race","methodname","catch","Notification","exception","ajaxResponseProcessor","url","response","data","rowstring","JSON","parse","init","tabulatorelementid","requiredFilters","window","moment","tableelement","placeHolderMessage","columns","Tabulator","ajaxRequestFunc","config","table","getPageSize","ajaxURL","pagination","paginationSize","ajaxFiltering","ajaxSorting","paginationDataReceived","ajaxResponse","layout","placeholder","rowClick","row","document","trigger"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module to create a dynamic table a bit similar to the core\n * dynamic table but with more functionalities.\n * We use the Tabulator library.\n *\n * @module   local_cltools/table/dynamic.js\n * @copyright 2021 - CALL Learning - Laurent David <laurent@call-learning.fr>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Tabulator from 'local_cltools/local/table/tabulator-lazy';\nimport moment from 'local_cltools/local/moment-lazy';\nimport $ from 'jquery';\nimport {call as ajaxCall} from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport {formatterFilterTransform} from './tabulator-converters';\nimport {MOODLE_FILTER_CONVERTER, JOINTYPE_ANY, JOINTYPE_ALL} from './moodle-filter-converters';\n\n\nconst rowQuery = (tableHandler, tableUniqueid, pageSize, params, initialFilters) => {\n    let filters = (typeof params.filters === \"undefined\") ? [] : params.filters.map(\n        (e) => {\n            let filter = {\n                'name': e.field, 'type': e.type, 'jointype': JOINTYPE_ANY, 'values': e.value\n            };\n            if (e.type in MOODLE_FILTER_CONVERTER) {\n                const converter = MOODLE_FILTER_CONVERTER[e.type];\n                filter.type = converter.to;\n                if (typeof converter.transformer !== \"undefined\") {\n                    filter.values = converter.transformer(e.value);\n                }\n            }\n            return filter;\n        }\n    );\n    if (initialFilters) {\n        filters.concat(initialFilters);\n    }\n    const args = {\n        handler: tableHandler,\n        uniqueid: tableUniqueid,\n        sortdata: (typeof params.sorters === \"undefined\") ? [] : params.sorters.map(\n            (e) => {\n                return {'sortby': e.field, 'sortorder': e.dir.toUpperCase()};\n            }\n        ),\n        filters: filters,\n        jointype: JOINTYPE_ALL,\n        pagenumber: params.page,\n        pagesize: pageSize,\n        hiddencolumns: [],\n        resetpreferences: false,\n        firstinitial: \"A\",\n        lastinitial: \"Z\"\n    };\n    return Promise.race(\n        ajaxCall(\n            [{\n                methodname: 'cltools_dynamic_table_get_rows',\n                args: args\n            }]\n        )\n    ).catch(Notification.exception);\n};\n\nconst ajaxResponseProcessor = function (url, params, response) {\n    response.data = response.data.map(\n        (rowstring) => JSON.parse(rowstring)\n    );\n    return response;\n};\n\nexport const init = async (tabulatorelementid, requiredFilters) => {\n    if (typeof window.moment == \"undefined\") {\n        window.moment = moment;\n    }\n    const tableelement = $(\"#\" + tabulatorelementid);\n\n    const placeHolderMessage = await getString('table:nodata', 'local_cltools');\n    const columns = await Promise.race(ajaxCall(\n        [{\n            methodname: 'cltools_dynamic_table_get_columns',\n            args: {\n                handler: tableelement.data('tableHandler'),\n                uniqueid: tableelement.data('tableUniqueid'),\n            }\n        }])).catch(Notification.exception);\n    new Tabulator(\"#\" + tabulatorelementid, {\n        ajaxRequestFunc: function (url, config, params) {\n            const tableHandler = tableelement.data('tableHandler');\n            const tableUniqueid = tableelement.data('tableUniqueid');\n            const pageSize = this.table.getPageSize();\n            return rowQuery(tableHandler, tableUniqueid, pageSize, params, requiredFilters);\n        },\n        ajaxURL: true, // If not set the RequestFunct will never be called.\n        pagination: \"remote\",\n        paginationSize: tableelement.data('table-pagesize'),\n        ajaxFiltering: true,\n        ajaxSorting: true,\n        paginationDataReceived: {\n            \"last_page\": \"pagescount\", // Change last_page parameter name to \"pagescount\".\n        },\n        ajaxResponse: ajaxResponseProcessor,\n        columns: formatterFilterTransform(columns),\n        layout: \"fitColumns\",\n        placeholder: placeHolderMessage,\n        rowClick: (e, row) => {\n            $(document).trigger('tabulator-row-click', [row, tableelement.data('tableUniqueid')]);\n        }\n    });\n\n};\n"],"file":"dynamic.min.js"}